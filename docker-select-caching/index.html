<!DOCTYPE html><html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us"><head><link href="http://gmpg.org/xfn/11" rel="profile"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"><meta property="og:title" content="Selectively disable caching for specific RUN commands in Dockerfile"/><meta property="og:type" content="article"/><meta property="og:url" content="http://dev.im-bot.com/docker-select-caching//"/><meta property="og:image" content="http://dev.im-bot.com/public/opengraph_logo.png"/><meta property="og:description" content="If you using Dockerfile, you should know about caching for faster builds.Sometimes, you need to rebuild without cache. you can run docker build with--no-cach..."/><meta property="og:site_name" content="botbotbot"/><meta property="og:locale" content="th_TH"/><title> Selectively disable caching for specific RUN commands in Dockerfile · botbotbot</title><link rel="stylesheet" href="/public/css/poole.css"><link rel="stylesheet" href="/public/css/syntax.css"><link rel="stylesheet" href="/public/css/lanyon.css"><link rel="stylesheet" href="/public/css/searchbox.css"><link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Serif:400,400italic,700|PT+Sans:400"><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css"><link rel="apple-touch-icon-precomposed" sizes="144x144" href="/public/apple-touch-icon-144-precomposed.png"><link rel="shortcut icon" href="/public/favicon.ico"><link rel="alternate" type="application/rss+xml" title="RSS" href="/feed.xml"> <script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src=n,s.parentNode.insertBefore(o,s)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-52133577-1","auto"),ga("send","pageview")</script></head><body> <input type="checkbox" class="sidebar-checkbox" id="sidebar-checkbox"><div class="sidebar" id="sidebar"><div class="sidebar-item"><p>botbotbot's blog</p></div><nav class="sidebar-nav"> <a class="sidebar-nav-item" href="/">Home</a> <a class="sidebar-nav-item" href="/about/">About Me</a> <a class="sidebar-nav-item" href="/tags/">Tags</a><div class="sidebar-item"><p> © 2016. All rights reserved.</p></div></div><div class="wrap"><div class="masthead"><div class="container"><h3 class="masthead-title"> <a href="/" title="Home">botbotbot</a> <small>'s blog</small> <span id="search"><form action="/search" id="searchbox"> <input id="search-query" placeholder="Search" autocomplete="off" name="q"></form> </span></h3></div></div><div class="container"><div class="post"> <section id="search-results" style="display:none"><div id="close-search-results"><h1 class="post-title"> Search results <i class="fa fa-times" style="font-size:.7em"></i></h1></div><div class="entries"></div> </section></div></div><div class="container content"><div class="post"><h1 class="post-title">Selectively disable caching for specific RUN commands in Dockerfile</h1> <span class="post-date"> 24 Mar 2016 · <a href="/docker-select-caching//index.html#disqus_thread" data-disqus-identifier="/docker-select-caching/"></a> · Updated March 24, 2016 </span><p>If you using <code>Dockerfile</code>, you should know about caching for faster builds. Sometimes, you need to rebuild without cache. you can run docker <code>build</code> with <code>--no-cache</code> option that will disable all layer cache.</p><p>There is problem when you should use some <code>Dockerfile</code> commands like <code>ADD</code> or <code>COPY</code> to copy file form host to container.</p><p>You need to copy new file to container then rebuild again without change any line of <code>Dockerfile</code> but the new file not was copy to container. The last build using layer cache that contain old file instead of rebuild with new file. So this problem can solve easily by using <code>--no-cache</code> buuild option that disable all layer cache.</p><p>Sometimes, you need to rebuild only some layer not all layer. For this case, there is not native solution for Docker but there is some trick about <code>ARG</code> command in <code>Dockerfile</code> and <code>--build-arg</code> build option that I found on <a href="https://github.com/docker/docker/issues/1996#issuecomment-172606763">New feature request: Selectively disable caching for specific RUN commands in Dockerfile</a> for more detail you should look at <a href="https://github.com/docker/docker/issues/1996#issuecomment-185872769">solution description</a> and <a href="https://docs.docker.com/engine/reference/builder/#arg">Dockerfile - ARG</a></p><p>add <code>ARG</code> command to your <code>Dockerfile</code></p><div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="c"># Dockerfile</span>
<span class="c"># add this and below command will run without cache</span>
ARG <span class="nv">CACHEBUST</span><span class="o">=</span>1
</code></pre></div><p>when you need to rebuild with selected cache, run it with <code>--build-arg</code> option</p><div class="highlight"><pre><code class="language-sh" data-lang="sh"><span class="gp">$ </span>docker build -t your-image --build-arg <span class="nv">CACHEBUST</span><span class="o">=</span><span class="k">$(</span>date +%s<span class="k">)</span> .
</code></pre></div><p>then only layer below <code>ARG</code> command in <code>Dockerfile</code> will rebuild.</p><h1 id="references">References:</h1><ul><li><a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/#build-cache">Build Cache - Best practices for writing Dockerfiles</a></li><li><a href="https://docs.docker.com/engine/reference/builder/#arg">Dockerfile - ARG</a></li><li><a href="https://github.com/docker/docker/issues/1996#issuecomment-172606763">Temporary Solution - Selectively disable caching for specific RUN commands in Dockerfile</a> - <a href="https://github.com/docker/docker/issues/1996#issuecomment-185872769">An additional description </a>)</li></ul></div><div class="related"><h2>Related Posts</h2><ul class="related-posts"><li><h3> <a href="/cassandra/"> What I know about Apache Cassandra <small>24 Mar 2016</small> </a></h3></li><li><h3> <a href="/docker-cron/"> Crontab on Docker <small>04 Mar 2016</small> </a></h3></li><li><h3> <a href="/docker-reduce-image-size/"> Reduce docker image size <small>03 Mar 2016</small> </a></h3></li></ul></div><div class="related"><div id="disqus_thread"></div> <script>var disqus_shortname="im-bot",disqus_identifier="/docker-select-caching/";!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="//"+disqus_shortname+".disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript></div></div></div><label for="sidebar-checkbox" class="sidebar-toggle"></label> <script>var disqus_shortname="im-bot";!function(){var t=document.createElement("script");t.async=!0,t.type="text/javascript",t.src="http://"+disqus_shortname+".disqus.com/count.js",(document.getElementsByTagName("HEAD")[0]||document.getElementsByTagName("BODY")[0]).appendChild(t)}()</script></body> <script src="/js/search.min.js" charset="utf-8"></script><script id="search-results-template" type="text/mustache">
    {{#entries}}
      <article>
        <h3>
          {{#date}}<small><time datetime="{{pubdate}}" pubdate>{{displaydate}}</time></small>{{/date}}
          <a href="{{url}}">{{title}}</a>
        </h3>
      </article>
    {{/entries}}
  </script><script>$(function(){$("#search-query").lunrSearch({indexUrl:"/js/index.json",results:"#search-results",entries:".entries",template:"#search-results-template"})}),$("#close-search-results").click(function(){$("#search-query").val(""),$("#search-results").hide()})</script></html>